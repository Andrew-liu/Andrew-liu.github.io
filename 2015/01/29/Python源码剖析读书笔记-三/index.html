<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Python源码剖析读书笔记(三) · Snow Memory | Andrew Liu</title><meta name="description" content="Python源码剖析读书笔记(三) - Andrew Liu"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://andrewliu.in/atom.xml" title="Snow Memory | Andrew Liu"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/dinosaurliu" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/Andrew-liu" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Python源码剖析读书笔记(三)</h1><div class="post-info">Jan 29, 2015</div><div class="post-content"><blockquote>
<p>整本源码剖析的书基本看完, 不过我觉得第二部分有太多不解, 另外第三部分也是精华, 等过段时间会再看一遍, 听说这本书第二版在编辑中, 等书出了一定要第一时间买一本…</p>
</blockquote>
<h2 id="1-Python运行环境初始化"><a href="#1-Python运行环境初始化" class="headerlink" title="#1. Python运行环境初始化"></a>#1. Python运行环境初始化</h2><p>python运行时环境初始化从<code>Py_InitializeEX</code>(pythonrun.c)开始.其中PyInterpreterState是对进程的模拟, PyThreadState是对线程的模拟.</p>
<p><strong>Py_InitializeEX:</strong></p>
<a id="more"></a>
<ul>
<li>调用PyInterpreterState_New创建一个新的PyInterpreterState对象(pystate.c), python运行中interp_head全局管理一个PyInterpreterState对象链表(多进程)</li>
<li>调用PyThreadState_New创建一个新的PyThreadState对象(pystate.c),并关联进程和线程</li>
<li>python运行环境中, _PyThreadState_Current全局变量维护当前活动线程对应的PyThreadState对象</li>
<li>创建进程线程对象后, 通过<code>_PyBuiltin_Init</code>设置系统<code>__builtin__</code> module(所有类型对象,函数集合, 文档),interp-&gt;builtins</li>
<li>设置sys module, interp-&gt;sysdict</li>
<li>设置python收缩module的默认搜索路径集合PySys_SetPath(sysmodule.c)</li>
<li>初始化import环境<code>_PyImport_Init()</code></li>
<li>初始化python内建exceptions</li>
<li>备份exceptions module和内建模块</li>
<li>在sys module中添加一些对象, 用于import机制</li>
<li>python之后将创建<code>__main__</code> module, 加入到interp-&gt;modules(作为主程序运行的源文件可视为<code>__main__</code>), python运行程序沿着名字空间找到<code>__name__</code>就是<code>__main__</code></li>
<li><code>site.py</code>将site-package加入到sys.path中</li>
</ul>
<p><img src="http://picturebag.qiniudn.com/69.png" alt="进程"></p>
<p><img src="http://picturebag.qiniudn.com/70.png" alt="初始化"></p>
<p>##1.1. 激活虚拟机</p>
<p>Py_InitializeEX成功完成后, 调用<code>PyRun_AnyFileExFlags</code>(main.c)`进入字节码虚拟机, 通过Py_FdIsInteractive判断是否为交互式方式运行, 是则执行PyRun_InteractiveLoopFlags; 不是则执行PyRun_SimpleFileExFlags</p>
<ul>
<li>交互式运行方法<ol>
<li>执行PyRun_InteractiveLoopFlags(pythonrun.c)</li>
<li>创建交互式环境提示符</li>
<li>进入交互式环境</li>
<li>通过PyRun_InteractiveOneFlags函数编译交互式环境输入的python语句(生成抽象语法树), 执行输入的python代码(run_mod)</li>
</ol>
</li>
</ul>
<ul>
<li>脚本文件运行方法<ol>
<li>执行PyRun_SimpleFileExFlags(pythonrun.c)</li>
<li>在<code>__main__</code> module中设置<code>__file__</code>属性</li>
<li>通过PyRun_FileExFlags执行脚本文件</li>
<li>编译并执行(run_mod)</li>
</ol>
</li>
</ul>
<p>##1.2. 启动虚拟机</p>
<p>run_mode开始, python启动字节码虚拟机</p>
<ol>
<li>基于抽象语法树编译字节码指令序列, 创建PycodeObject对象</li>
<li>创建PyFrameObject对象(运行环境), 执行PyCodeObject中的字节码指令序列</li>
</ol>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#pythonrun.c</span></div><div class="line">static PyObject *</div><div class="line">run_mod(mod_ty mod, const char *filename, PyObject *globals, PyObject *locals,</div><div class="line">         PyCompilerFlags *flags, PyArena *arena)</div><div class="line">&#123;</div><div class="line">    PyCodeObject *co;</div><div class="line">    PyObject *v;</div><div class="line">    co = PyAST_Compile(mod, filename, flags, arena); <span class="comment">#编译</span></div><div class="line">    <span class="keyword">if</span> (co == NULL)</div><div class="line">        <span class="keyword">return</span> NULL;</div><div class="line">    <span class="comment">#创建PyFrameObject对象, 执行code对象中字节码指令序列</span></div><div class="line">    v = PyEval_EvalCode(co, globals, locals); </div><div class="line">    Py_DECREF(co);</div><div class="line">    <span class="keyword">return</span> v;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">#ceval.c</span></div><div class="line">PyObject *</div><div class="line">PyEval_EvalCode(PyCodeObject *co, PyObject *globals, PyObject *locals)</div><div class="line">&#123;   <span class="comment">#唤醒字节码虚拟机, 在其中的PyFrame_New设置local/global/builtin名字空间</span></div><div class="line">    <span class="keyword">return</span> PyEval_EvalCodeEx(co,</div><div class="line">                      globals, locals,</div><div class="line">                      (PyObject **)NULL, <span class="number">0</span>,</div><div class="line">                      (PyObject **)NULL, <span class="number">0</span>,</div><div class="line">                      (PyObject **)NULL, <span class="number">0</span>,</div><div class="line">                      NULL);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>python所有的线程共享相同的builtin名字空间</p>
</blockquote>
<p><img src="http://picturebag.qiniudn.com/65.png" alt="运行时"></p>
<h2 id="2-Python模块的动态加载机制"><a href="#2-Python模块的动态加载机制" class="headerlink" title="#2. Python模块的动态加载机制"></a>#2. Python模块的动态加载机制</h2><p>python的一个module从硬盘到内存的加载</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_moudules</span><span class="params">()</span> :</span></div><div class="line">    <span class="keyword">import</span> sys</div><div class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> sys.modules.items() :</div><div class="line">        <span class="keyword">print</span> item</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    show_moudules()</div></pre></td></tr></table></figure>
<p>嵌套的import操作并不影响上一层的孔子空间, 只影响各自module自身的名字空间(module自身维护的dict)</p>
<ul>
<li>Python中,module是由一个单独的文件实现的</li>
<li>package是通过文件夹来实现的(文件夹中要由<code>__init__.py</code>)</li>
</ul>
<p><strong>动态加载</strong></p>
<p>在加载module时, 如A.B.c, python内部将这个module表示为一个树状结构, python动态加载时, 首先会将树状结构分解, 形成(A, B, c)节点集合, 然后从左到右依次到sys.modules中查找每一个符号所对应的module是否已经能够被加载. 如果被加载了, 则A对应PyModuleObject对象中维护着一个元信息<code>__path__</code>, 表示这个package路径.此时B,c没有加载, 接下来对B的搜索只在<code>A.__path__中进行</code></p>
<blockquote>
<p>其中sys.modules集合作为module pool, 保存module的唯一映像, 某个.py文件通过import声明时,python将在这个pool中寻找, 如存在, 则引入符号到该.py的命名空间中, 并将其关联到该module. 如果不在pool, 这是才进行动态加载</p>
</blockquote>
<p>##2.1. from和import</p>
<p>from和import结合, 使用python虚拟街在当前名字空间中引入符号尽可能少, 从而避免名字空间污染</p>
<p><strong>python还提供了符号重命名机制</strong></p>
<p>通过as关键字控制module以什么名字被引入到当前的local名字空间</p>
<p><strong>符号的销毁和重载</strong></p>
<p>通过import加载module会一直占用内存, 通过del在命名空间删除该符号, 通过reload对module进行重载</p>
<p>##2.2. import实现机制</p>
<blockquote>
<p>import机制起点是builtin module中的<code>___import__</code>操作(<code>builtin___import__</code>函数)</p>
</blockquote>
<p>import机制3个功能:</p>
<ul>
<li>python运行时的全局module pool的维护和搜索</li>
<li>解析与搜索module路径的树状结构</li>
<li>对不同文件格式的module的动态加载机制</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//bltinmodule.c</span></div><div class="line"><span class="function"><span class="keyword">static</span> PyObject *</span></div><div class="line"><span class="title">builtin___import__</span><span class="params">(PyObject *self, PyObject *args, PyObject *kwds)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> *kwlist[] = &#123;<span class="string">"name"</span>, <span class="string">"globals"</span>, <span class="string">"locals"</span>, <span class="string">"fromlist"</span>,</div><div class="line">                             <span class="string">"level"</span>, <span class="number">0</span>&#125;;</div><div class="line">    <span class="keyword">char</span> *name;</div><div class="line">    PyObject *globals = <span class="literal">NULL</span>;</div><div class="line">    PyObject *locals = <span class="literal">NULL</span>;</div><div class="line">    PyObject *fromlist = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">int</span> level = <span class="number">-1</span>;</div><div class="line">    <span class="comment">//从tuple中解析需要的信息</span></div><div class="line">    <span class="keyword">if</span> (!PyArg_ParseTupleAndKeywords(args, kwds, <span class="string">"s|OOOi:__import__"</span>,</div><div class="line">                    kwlist, &amp;name, &amp;globals, &amp;locals, &amp;fromlist, &amp;level))</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">return</span> PyImport_ImportModuleLevel(name, globals, locals,</div><div class="line">                                      fromlist, level);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">#import.c</span></div><div class="line"><span class="function">PyObject *</span></div><div class="line"><span class="title">PyImport_ImportModuleLevel</span><span class="params">(<span class="keyword">char</span> *name, PyObject *globals, PyObject *locals,</span></div><div class="line">                         PyObject *fromlist, <span class="keyword">int</span> level)</div><div class="line">&#123;</div><div class="line">    PyObject *result;</div><div class="line">    _PyImport_AcquireLock();</div><div class="line">    result = import_module_level(name, globals, locals, fromlist, level);</div><div class="line">    <span class="keyword">if</span> (_PyImport_ReleaseLock() &lt; <span class="number">0</span>) &#123;</div><div class="line">        Py_XDECREF(result);</div><div class="line">        PyErr_SetString(PyExc_RuntimeError,</div><div class="line">                        <span class="string">"not holding the import lock"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>执行<code>builtin___import__</code>函数完成对参数的拆包(进行import前, 会对import动作加锁, 进入import后, 解锁)</li>
<li>进入PyImport_ImportModuleLevel函数(<code>import.c</code>)执行<code>import_module_level</code>(对树形结构遍历), 获得import动作发生的packge环境, 解析module的路径结构(树), 依次加载每个package/module</li>
<li>在<code>import_module_level</code>中的load_next中调用<code>import_submodule</code>完成搜索module并加载module的工作</li>
<li>对于py文件虚拟机执行<code>load_source_module</code>(编译, 产生PyCodeObject对象执行字节码); 对于pyc, 虚拟机调用<code>load_compiled_module</code>(至少了编译动作); 对于内建module, 只有一部分常用的在运行时被加载到sys.modules中, 对于不常用的进行import操作,, 虚拟机调用<code>init_builtin</code>加载module(在内建module列表中找到后, 调用init初始化); 对于C扩展module, 会调用<code>_PyImport_LoadDynamicModule</code>(查找python的module备份是否有module, 获得module初始化起始地址并调用, 从sys.modules获得已经加载的module并设置<code>__file__</code>属性, 最后加入到python的module备份)</li>
</ol>
<blockquote>
<p>import动作是发生在一个package环境中</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//内建module的完整列表</span></div><div class="line"></div><div class="line"><span class="comment">//import.h</span></div><div class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">inittab</span> &#123;</span></div><div class="line">    <span class="keyword">char</span> *name;</div><div class="line">    <span class="keyword">void</span> (*initfunc)(<span class="keyword">void</span>);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">//import.c</span></div><div class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">inittab</span> *<span class="title">PyImport_Inittab</span> = _<span class="title">PyImport_Inittab</span>;</span></div><div class="line"></div><div class="line"><span class="comment">//PC/config.c</span></div><div class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">inittab</span> _<span class="title">PyImport_Inittab</span>[] = &#123;</span></div><div class="line"></div><div class="line">    &#123;<span class="string">"array"</span>, initarray&#125;,</div><div class="line">    &#123;<span class="string">"_ast"</span>, init_ast&#125;,</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> MS_WINDOWS</span></div><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> MS_WINI64</span></div><div class="line">    &#123;<span class="string">"audioop"</span>, initaudioop&#125;,</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">    &#123;<span class="string">"binascii"</span>, initbinascii&#125;,</div><div class="line">    &#123;<span class="string">"cmath"</span>, initcmath&#125;,</div><div class="line">    &#123;<span class="string">"errno"</span>, initerrno&#125;,</div><div class="line">    &#123;<span class="string">"future_builtins"</span>, initfuture_builtins&#125;,</div><div class="line">    &#123;<span class="string">"gc"</span>, initgc&#125;,</div><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> MS_WINI64</span></div><div class="line">    &#123;<span class="string">"imageop"</span>, initimageop&#125;,</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">    &#123;<span class="string">"math"</span>, initmath&#125;,</div><div class="line">    &#123;<span class="string">"_md5"</span>, init_md5&#125;,</div><div class="line">    &#123;<span class="string">"nt"</span>, initnt&#125;, <span class="comment">/* Use the NT os functions, not posix */</span></div><div class="line">    &#123;<span class="string">"operator"</span>, initoperator&#125;,</div><div class="line">    &#123;<span class="string">"signal"</span>, initsignal&#125;,</div><div class="line">    &#123;<span class="string">"_sha"</span>, init_sha&#125;,</div><div class="line">    &#123;<span class="string">"_sha256"</span>, init_sha256&#125;,</div><div class="line">    &#123;<span class="string">"_sha512"</span>, init_sha512&#125;,</div><div class="line">    &#123;<span class="string">"strop"</span>, initstrop&#125;,</div><div class="line">    &#123;<span class="string">"time"</span>, inittime&#125;,</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> WITH_THREAD</span></div><div class="line">    &#123;<span class="string">"thread"</span>, initthread&#125;,</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">    &#123;<span class="string">"cStringIO"</span>, initcStringIO&#125;,</div><div class="line">    &#123;<span class="string">"cPickle"</span>, initcPickle&#125;,</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> WIN32</span></div><div class="line">    &#123;<span class="string">"msvcrt"</span>, initmsvcrt&#125;,</div><div class="line">    &#123;<span class="string">"_locale"</span>, init_locale&#125;,</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">    <span class="comment">/* XXX Should _subprocess go in a WIN32 block?  not WIN64? */</span></div><div class="line">    &#123;<span class="string">"_subprocess"</span>, init_subprocess&#125;,</div><div class="line"></div><div class="line">    &#123;<span class="string">"_codecs"</span>, init_codecs&#125;,</div><div class="line">    &#123;<span class="string">"_weakref"</span>, init_weakref&#125;,</div><div class="line">    &#123;<span class="string">"_hotshot"</span>, init_hotshot&#125;,</div><div class="line">    &#123;<span class="string">"_random"</span>, init_random&#125;,</div><div class="line">    &#123;<span class="string">"_bisect"</span>, init_bisect&#125;,</div><div class="line">    &#123;<span class="string">"_heapq"</span>, init_heapq&#125;,</div><div class="line">    &#123;<span class="string">"_lsprof"</span>, init_lsprof&#125;,</div><div class="line">    &#123;<span class="string">"itertools"</span>, inititertools&#125;,</div><div class="line">    &#123;<span class="string">"_collections"</span>, init_collections&#125;,</div><div class="line">    &#123;<span class="string">"_symtable"</span>, init_symtable&#125;,</div><div class="line">    &#123;<span class="string">"mmap"</span>, initmmap&#125;,</div><div class="line">    &#123;<span class="string">"_csv"</span>, init_csv&#125;,</div><div class="line">    &#123;<span class="string">"_sre"</span>, init_sre&#125;,</div><div class="line">    &#123;<span class="string">"parser"</span>, initparser&#125;,</div><div class="line">    &#123;<span class="string">"_winreg"</span>, init_winreg&#125;,</div><div class="line">    &#123;<span class="string">"_struct"</span>, init_struct&#125;,</div><div class="line">    &#123;<span class="string">"datetime"</span>, initdatetime&#125;,</div><div class="line">    &#123;<span class="string">"_functools"</span>, init_functools&#125;,</div><div class="line">    &#123;<span class="string">"_json"</span>, init_json&#125;,</div><div class="line"></div><div class="line">    &#123;<span class="string">"xxsubtype"</span>, initxxsubtype&#125;,</div><div class="line">    &#123;<span class="string">"zipimport"</span>, initzipimport&#125;,</div><div class="line">    &#123;<span class="string">"zlib"</span>, initzlib&#125;,</div><div class="line"></div><div class="line">    <span class="comment">/* CJK codecs */</span></div><div class="line">    &#123;<span class="string">"_multibytecodec"</span>, init_multibytecodec&#125;,</div><div class="line">    &#123;<span class="string">"_codecs_cn"</span>, init_codecs_cn&#125;,</div><div class="line">    &#123;<span class="string">"_codecs_hk"</span>, init_codecs_hk&#125;,</div><div class="line">    &#123;<span class="string">"_codecs_iso2022"</span>, init_codecs_iso2022&#125;,</div><div class="line">    &#123;<span class="string">"_codecs_jp"</span>, init_codecs_jp&#125;,</div><div class="line">    &#123;<span class="string">"_codecs_kr"</span>, init_codecs_kr&#125;,</div><div class="line">    &#123;<span class="string">"_codecs_tw"</span>, init_codecs_tw&#125;,</div><div class="line"></div><div class="line"><span class="comment">/* tools/freeze/makeconfig.py marker for additional "_inittab" entries */</span></div><div class="line"><span class="comment">/* -- ADDMODULE MARKER 2 -- */</span></div><div class="line"></div><div class="line">    <span class="comment">/* This module "lives in" with marshal.c */</span></div><div class="line">    &#123;<span class="string">"marshal"</span>, PyMarshal_Init&#125;,</div><div class="line"></div><div class="line">    <span class="comment">/* This lives it with import.c */</span></div><div class="line">    &#123;<span class="string">"imp"</span>, initimp&#125;,</div><div class="line"></div><div class="line">    <span class="comment">/* These entries are here for sys.builtin_module_names */</span></div><div class="line">    &#123;<span class="string">"__main__"</span>, <span class="literal">NULL</span>&#125;,</div><div class="line">    &#123;<span class="string">"__builtin__"</span>, <span class="literal">NULL</span>&#125;,</div><div class="line">    &#123;<span class="string">"sys"</span>, <span class="literal">NULL</span>&#125;,</div><div class="line">    &#123;<span class="string">"exceptions"</span>, <span class="literal">NULL</span>&#125;,</div><div class="line">    &#123;<span class="string">"_warnings"</span>, _PyWarnings_Init&#125;,</div><div class="line"></div><div class="line">    &#123;<span class="string">"_io"</span>, init_io&#125;,</div><div class="line"></div><div class="line">    <span class="comment">/* Sentinel */</span></div><div class="line">    &#123;<span class="number">0</span>, <span class="number">0</span>&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="3-python多线程机制"><a href="#3-python多线程机制" class="headerlink" title="#3. python多线程机制"></a>#3. python多线程机制</h2><blockquote>
<p>Python通过GIL来互斥不同线程对解释器的使用, python借助底层操作系统提供的线程调度机制来决定下一个进入python解释器的线程.</p>
</blockquote>
<p>##3.1. python thread</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//threadmodule.c</span></div><div class="line"><span class="keyword">static</span> PyMethodDef thread_methods[] = &#123;</div><div class="line">    &#123;<span class="string">"start_new_thread"</span>,        (PyCFunction)thread_PyThread_start_new_thread,</div><div class="line">                            METH_VARARGS,</div><div class="line">                            start_new_doc&#125;,</div><div class="line">    &#123;<span class="string">"start_new"</span>,               (PyCFunction)thread_PyThread_start_new_thread,</div><div class="line">                            METH_VARARGS,</div><div class="line">                            start_new_doc&#125;,</div><div class="line">    &#123;<span class="string">"allocate_lock"</span>,           (PyCFunction)thread_PyThread_allocate_lock,</div><div class="line">     METH_NOARGS, allocate_doc&#125;,</div><div class="line">    &#123;<span class="string">"allocate"</span>,                (PyCFunction)thread_PyThread_allocate_lock,</div><div class="line">     METH_NOARGS, allocate_doc&#125;,</div><div class="line">    &#123;<span class="string">"exit_thread"</span>,             (PyCFunction)thread_PyThread_exit_thread,</div><div class="line">     METH_NOARGS, exit_doc&#125;,</div><div class="line">    &#123;<span class="string">"exit"</span>,                    (PyCFunction)thread_PyThread_exit_thread,</div><div class="line">     METH_NOARGS, exit_doc&#125;,</div><div class="line">    &#123;<span class="string">"interrupt_main"</span>,          (PyCFunction)thread_PyThread_interrupt_main,</div><div class="line">     METH_NOARGS, interrupt_doc&#125;,</div><div class="line">    &#123;<span class="string">"get_ident"</span>,               (PyCFunction)thread_get_ident,</div><div class="line">     METH_NOARGS, get_ident_doc&#125;,</div><div class="line">    &#123;<span class="string">"_count"</span>,                  (PyCFunction)thread__count,</div><div class="line">     METH_NOARGS, _count_doc&#125;,</div><div class="line">    &#123;<span class="string">"stack_size"</span>,              (PyCFunction)thread_stack_size,</div><div class="line">                            METH_VARARGS,</div><div class="line">                            stack_size_doc&#125;,</div><div class="line">    &#123;<span class="literal">NULL</span>,                      <span class="literal">NULL</span>&#125;           <span class="comment">/* sentinel */</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> PyObject *</span></div><div class="line"><span class="title">thread_PyThread_start_new_thread</span><span class="params">(PyObject *self, PyObject *fargs)</span></div><div class="line">&#123;</div><div class="line">    PyObject *func, *args, *keyw = <span class="literal">NULL</span>;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bootstate</span> *<span class="title">boot</span>;</span></div><div class="line">    <span class="keyword">long</span> ident;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!PyArg_UnpackTuple(fargs, <span class="string">"start_new_thread"</span>, <span class="number">2</span>, <span class="number">3</span>,</div><div class="line">                           &amp;func, &amp;args, &amp;keyw))</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">if</span> (!PyCallable_Check(func)) &#123;</div><div class="line">        PyErr_SetString(PyExc_TypeError,</div><div class="line">                        <span class="string">"first arg must be callable"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!PyTuple_Check(args)) &#123;</div><div class="line">        PyErr_SetString(PyExc_TypeError,</div><div class="line">                        <span class="string">"2nd arg must be a tuple"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (keyw != <span class="literal">NULL</span> &amp;&amp; !PyDict_Check(keyw)) &#123;</div><div class="line">        PyErr_SetString(PyExc_TypeError,</div><div class="line">                        <span class="string">"optional 3rd arg must be a dictionary"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//1. 创建并初始化bootstate结构, 在boot中保存关于线程的一切信息, </span></div><div class="line">    boot = PyMem_NEW(struct bootstate, <span class="number">1</span>);</div><div class="line">    <span class="keyword">if</span> (boot == <span class="literal">NULL</span>)</div><div class="line">        <span class="keyword">return</span> PyErr_NoMemory();</div><div class="line">    boot-&gt;interp = PyThreadState_GET()-&gt;interp;  <span class="comment">//保存PyInterpreterState对象</span></div><div class="line">    boot-&gt;func = func;</div><div class="line">    boot-&gt;args = args;</div><div class="line">    boot-&gt;keyw = keyw;</div><div class="line">    boot-&gt;tstate = _PyThreadState_Prealloc(boot-&gt;interp);</div><div class="line">    <span class="keyword">if</span> (boot-&gt;tstate == <span class="literal">NULL</span>) &#123;</div><div class="line">        PyMem_DEL(boot);</div><div class="line">        <span class="keyword">return</span> PyErr_NoMemory();</div><div class="line">    &#125;</div><div class="line">    Py_INCREF(func);</div><div class="line">    Py_INCREF(args);</div><div class="line">    Py_XINCREF(keyw);</div><div class="line">    <span class="comment">//2. 初始化多线程环境</span></div><div class="line">    PyEval_InitThreads(); <span class="comment">/* Start the interpreter's thread-awareness */</span></div><div class="line">    <span class="comment">//3. 创建操作系统原生线程</span></div><div class="line">    ident = PyThread_start_new_thread(t_bootstrap, (<span class="keyword">void</span>*) boot);</div><div class="line">    <span class="keyword">if</span> (ident == <span class="number">-1</span>) &#123;</div><div class="line">        PyErr_SetString(ThreadError, <span class="string">"can't start new thread"</span>);</div><div class="line">        Py_DECREF(func);</div><div class="line">        Py_DECREF(args);</div><div class="line">        Py_XDECREF(keyw);</div><div class="line">        PyThreadState_Clear(boot-&gt;tstate);</div><div class="line">        PyMem_DEL(boot);</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> PyInt_FromLong(ident);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//pythread.h</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> *PyThread_type_lock;</div><div class="line"></div><div class="line"><span class="comment">//ceval.c 初始化</span></div><div class="line"><span class="keyword">static</span> PyThread_type_lock interpreter_lock = <span class="number">0</span>; <span class="comment">/* This is the GIL */</span></div><div class="line"><span class="keyword">static</span> PyThread_type_lock pending_lock = <span class="number">0</span>; <span class="comment">/* for pending calls */</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">long</span> main_thread = <span class="number">0</span>;</div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">PyEval_InitThreads</span><span class="params">(<span class="keyword">void</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (interpreter_lock)</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    interpreter_lock = PyThread_allocate_lock(); <span class="comment">//创建GIL(PNRMUTEX aLock)thread_nt.h</span></div><div class="line">    PyThread_acquire_lock(interpreter_lock, <span class="number">1</span>);</div><div class="line">    main_thread = PyThread_get_thread_ident();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//thread_nt.c</span></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">NRMUTEX</span> &#123;</span></div><div class="line">    LONG   owned ;</div><div class="line">    DWORD  thread_id ;</div><div class="line">    HANDLE hevent ; <span class="comment">//event内核对象</span></div><div class="line">&#125; NRMUTEX, *PNRMUTEX ;</div></pre></td></tr></table></figure>
<ul>
<li>初始化线程环境: PyEval_InitThreads通过PyThread_allocate_lock创建GIL后, 调用任何python C API前, 必须获得GIL(PyThread_acquire_lock), 获得当前主线程的id, 并将其赋值为main_thread</li>
<li>创建线程: 主线程为执行程序时操作系统创建,主线程执行初始化获得GIL 子线程是在PyThread_start_new_thread函数中CreateThread创建出来的(程序中的start_new_thread, 是在主线程中执行的). 子线程创建自身线程状态对象后, 通过<code>_PyGILState_NotrThreadState</code>将这个对象放入线程状态对象链表</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">//thread_nt.c 创建线程</div><div class="line">long PyThread_start_new_thread(void (*func)(void *), void *arg)</div><div class="line">&#123;</div><div class="line">    HANDLE hThread;</div><div class="line">    unsigned threadID;</div><div class="line">    callobj *obj;</div><div class="line"></div><div class="line">    dprintf(("%ld: PyThread_start_new_thread called\n",</div><div class="line">             PyThread_get_thread_ident()));</div><div class="line">    if (!initialized)</div><div class="line">        PyThread_init_thread();</div><div class="line"></div><div class="line">    obj = (callobj*)HeapAlloc(GetProcessHeap(), 0, sizeof(*obj));</div><div class="line">    if (!obj)</div><div class="line">        return -1;</div><div class="line">    obj-&gt;func = func;</div><div class="line">    obj-&gt;arg = arg;</div><div class="line">#if defined(MS_WINCE)</div><div class="line">    hThread = CreateThread(NULL,</div><div class="line">                           Py_SAFE_DOWNCAST(_pythread_stacksize, Py_ssize_t, SIZE_T),</div><div class="line">                           bootstrap, obj, 0, &amp;threadID); //boostrap完成获得线程id, 通知obj-&gt;done内核对象, 调用t_bootstrap(在这个函数中与主线程竞争GIL, threadmodule.c), 在子线程中执行</div><div class="line">#else</div><div class="line">    hThread = (HANDLE)_beginthreadex(0,</div><div class="line">                      Py_SAFE_DOWNCAST(_pythread_stacksize,</div><div class="line">                                       Py_ssize_t, unsigned int),</div><div class="line">                      bootstrap, obj,</div><div class="line">                      0, &amp;threadID);</div><div class="line">#endif</div><div class="line">    if (hThread == 0) &#123;</div><div class="line">#if defined(MS_WINCE)</div><div class="line">        /* Save error in variable, to prevent PyThread_get_thread_ident</div><div class="line">           from clobbering it. */</div><div class="line">        unsigned e = GetLastError();</div><div class="line">        dprintf(("%ld: PyThread_start_new_thread failed, win32 error code %u\n",</div><div class="line">                 PyThread_get_thread_ident(), e));</div><div class="line">#else</div><div class="line">        /* I've seen errno == EAGAIN here, which means "there are</div><div class="line">         * too many threads".</div><div class="line">         */</div><div class="line">        int e = errno;</div><div class="line">        dprintf(("%ld: PyThread_start_new_thread failed, errno %d\n",</div><div class="line">                 PyThread_get_thread_ident(), e));</div><div class="line">#endif</div><div class="line">        threadID = (unsigned)-1;</div><div class="line">        HeapFree(GetProcessHeap(), 0, obj);</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        dprintf(("%ld: PyThread_start_new_thread succeeded: %p\n",</div><div class="line">                 PyThread_get_thread_ident(), (void*)hThread));</div><div class="line">        CloseHandle(hThread);</div><div class="line">    &#125;</div><div class="line">    return (long) threadID;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://picturebag.qiniudn.com/71.png" alt="线程"></p>
<p>每个将要从运行态转为等待态的线程都会在被挂起前调用PyThread_release_lock释放GIL(thread_xx.h)并通知所有等待GIL <code>event内核对象</code>的线程</p>
<p>##3.2. python线程的调度</p>
<blockquote>
<p>python线程调度机制内建在python解释器的核心PyEval_EvalFrameEx中</p>
</blockquote>
<p>主线程先获得GIL, 并执行PyEval_EvalFrameEx函数代码, 这是子线程在t_bootstrap中调用PyEval_AcquireThread, 通过调用PyThread_acquire_lock申请GIL, 但由于GIL被主线程调用, 子线程被挂起. 主线程不断执行字节码, <code>_Py_Ticker</code>不断减一, 当减到0, 将当前维护线程状态置NULL, 然后释放GIL,此时子线程<code>被操作系统的线程调度唤醒</code>, 从而进入PyEval_EvalFrameEx. 对于主线程虽然失去了GIL, 但是没被挂起, 所以可以被再次切换为活动线程, 再次申请GIL, 由于被子线程占有, 主线程将自身挂起.</p>
<p>##3.3. 阻塞调度</p>
<p>线程A通过某些操作(如等待输入), 将自身阻塞, python应将等待GIL的线程B唤醒.</p>
<p>##3.4. python子线程的销毁</p>
<blockquote>
<p>主线程销毁必须要销毁python的运行时环境, 子线程的销毁不需要进行这些动作</p>
</blockquote>
<p>线程的主框架在<code>t_bootstrap</code>中,</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//threadmodule.c</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></div><div class="line"><span class="title">t_bootstrap</span><span class="params">(<span class="keyword">void</span> *boot_raw)</span></div><div class="line">&#123;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bootstate</span> *<span class="title">boot</span> = (<span class="title">struct</span> <span class="title">bootstate</span> *) <span class="title">boot_raw</span>;</span></div><div class="line">    PyThreadState *tstate;</div><div class="line">    PyObject *res;</div><div class="line"></div><div class="line">    tstate = boot-&gt;tstate;</div><div class="line">    tstate-&gt;thread_id = PyThread_get_thread_ident();</div><div class="line">    _PyThreadState_Init(tstate);</div><div class="line">    PyEval_AcquireThread(tstate);</div><div class="line">    nb_threads++;</div><div class="line">    res = PyEval_CallObjectWithKeywords(</div><div class="line">        boot-&gt;func, boot-&gt;args, boot-&gt;keyw);</div><div class="line">    <span class="keyword">if</span> (res == <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (PyErr_ExceptionMatches(PyExc_SystemExit))</div><div class="line">            PyErr_Clear();</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            PyObject *file;</div><div class="line">            PyObject *exc, *value, *tb;</div><div class="line">            PyErr_Fetch(&amp;exc, &amp;value, &amp;tb);</div><div class="line">            PySys_WriteStderr(</div><div class="line">                <span class="string">"Unhandled exception in thread started by "</span>);</div><div class="line">            file = PySys_GetObject(<span class="string">"stderr"</span>);</div><div class="line">            <span class="keyword">if</span> (file)</div><div class="line">                PyFile_WriteObject(boot-&gt;func, file, <span class="number">0</span>);</div><div class="line">            <span class="keyword">else</span></div><div class="line">                PyObject_Print(boot-&gt;func, <span class="built_in">stderr</span>, <span class="number">0</span>);</div><div class="line">            PySys_WriteStderr(<span class="string">"\n"</span>);</div><div class="line">            PyErr_Restore(exc, value, tb);</div><div class="line">            PyErr_PrintEx(<span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        Py_DECREF(res);</div><div class="line">    Py_DECREF(boot-&gt;func);</div><div class="line">    Py_DECREF(boot-&gt;args);</div><div class="line">    Py_XDECREF(boot-&gt;keyw);</div><div class="line">    PyMem_DEL(boot_raw);</div><div class="line">    nb_threads--;</div><div class="line">    PyThreadState_Clear(tstate);  <span class="comment">//清理当前线程锁对应的线程状态对象, 引用计数的维护</span></div><div class="line">    PyThreadState_DeleteCurrent();  <span class="comment">//释放GIL</span></div><div class="line">    PyThread_exit_thread();  <span class="comment">//完成不同平台销毁原生线程的工作</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>##3.5. Python线程的用户级互斥和同步</p>
<blockquote>
<p>python的线程在GIL控制下, 线程之间, 对python解释器, 对C API的访问都是互斥的.(<code>内核级互斥, 用户不可控</code>)</p>
</blockquote>
<p>thread中提供了Lock对象, thread.allocate对应的C函数<code>thread_PyThread_allocate_lock</code>, 创建一个lockobject对象,</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//threadmodule.c</span></div><div class="line"><span class="comment">/* Lock objects */</span></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">    PyObject_HEAD</div><div class="line">    PyThread_type_lock lock_lock;  <span class="comment">//Event内核对象</span></div><div class="line">    PyObject *in_weakreflist;</div><div class="line">&#125; lockobject;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> PyObject *</span></div><div class="line"><span class="title">thread_PyThread_allocate_lock</span><span class="params">(PyObject *self)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> (PyObject *) newlockobject();</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">static</span> lockobject *</span></div><div class="line"><span class="title">newlockobject</span><span class="params">(<span class="keyword">void</span>)</span></div><div class="line">&#123;</div><div class="line">    lockobject *self;</div><div class="line">    self = PyObject_New(lockobject, &amp;Locktype);</div><div class="line">    <span class="keyword">if</span> (self == <span class="literal">NULL</span>)</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    self-&gt;lock_lock = PyThread_allocate_lock();</div><div class="line">    self-&gt;in_weakreflist = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">if</span> (self-&gt;lock_lock == <span class="literal">NULL</span>) &#123;</div><div class="line">        Py_DECREF(self);</div><div class="line">        PyErr_SetString(ThreadError, <span class="string">"can't allocate lock"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> self;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>关于对thread module封装的threading, 调用threading.thread.start时, 会在<code>_limbo</code>中记录线程, 通过thread.start_new_thread创建原生线程, 线程过程为<code>__bootstrap</code>. 在bootstrap中, 会在_limo中删除线程记录, 转而将线程记录到<code>_active</code>中, 然后调用run, run结束后, 会调用__stop操作, 会调用其中Condition对象的notifyAll通知等待该对象的线程, 这些线程会通过threading.Thread.join操作注册成为Condition对象的等待线程.</p>
<h2 id="4-Python内存管理"><a href="#4-Python内存管理" class="headerlink" title="#4. Python内存管理"></a>#4. Python内存管理</h2><blockquote>
<p>python所有内存管理有两套实现, 由编译符号<code>PYMALLOC_DEBUG控制</code>, debug模式和正常的内存管理模式</p>
</blockquote>
<p>内存管理的抽象层次:</p>
<ol>
<li>最底层(第0层), 操作系统提供的内存管理接口, 比如C运行时的malloc和free接口, 由操作系统管理和实现, python不能干涉, 其他层由python实现并维护</li>
<li>第1层是python基于第0层操作系统的内存管理接口包装形成的(处理平台相关的内存分配行为, PyMem_API)</li>
<li>第2层更高抽象层次的内存管理接口, 是一组以PyObje_为前缀的函数族(主要提供创建Python对象的接口)</li>
<li>第3层主要是对对象缓冲池机制(GC机制)</li>
</ol>
<p>##4.1. 小块空间的内存池</p>
<blockquote>
<p>小块内存池可以看做4层结构: <code>block, pool, arena, 内存池</code></p>
</blockquote>
<ul>
<li>block是确定大小的内存块(8字节对齐, 8, 16, 32…512, 内存小大称为size class, 每个size class对应一个size class index, index从0开始)</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//obmalloc.c</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> ALIGNMENT               8               <span class="comment">/* must be 2^N */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> ALIGNMENT_SHIFT         3</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> ALIGNMENT_MASK          (ALIGNMENT - 1)</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SMALL_REQUEST_THRESHOLD 512 </span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NB_SMALL_SIZE_CLASSES   (SMALL_REQUEST_THRESHOLD / ALIGNMENT)</span></div></pre></td></tr></table></figure>
<blockquote>
<p>当申请一个28字节内存时, PyObject_Malloc从内存池中分配一个32字节的block, 从size class index为3的pool中分配</p>
</blockquote>
<ul>
<li>pool管理一堆固定大小的内存块, pool大小一般为系统内存页(一般为4K, 包括pool_header头部和block几何占用的内存) </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//obmalloc.c</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SYSTEM_PAGE_SIZE        (4 * 1024)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SYSTEM_PAGE_SIZE_MASK   (SYSTEM_PAGE_SIZE - 1)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> POOL_SIZE               SYSTEM_PAGE_SIZE        <span class="comment">/* must be 2^N */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> POOL_SIZE_MASK          SYSTEM_PAGE_SIZE_MASK</span></div></pre></td></tr></table></figure>
<blockquote>
<p>每一个pool都和一个size class index关联.</p>
</blockquote>
<p>将4K内存转换为pool, pool先指向一块4K内存, 设置pool的size class index, 将index转换为size(index = 3即32字节, index = 0即8字节),跳过pool_header的内存, 进行对齐, 当对其中block进行分配时, 如果某些block内存被释放了, 则通过自由block链表(pool_header中的freeblock)进行管理</p>
<ul>
<li>arena是多个pool的集合(256KB), 容纳pool的个数是ARENA_SIZE/POOL_SIZE = 64, <code>arena管理的内存是分离的, pool_header自身是连续的内存</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//obmalloc.c</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> ARENA_SIZE              (256 &lt;&lt; 10)     <span class="comment">/* 256KB */</span></span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arena_object</span> &#123;</span></div><div class="line">    <span class="comment">/* The address of the arena, as returned by malloc.  Note that 0</span></div><div class="line">     * will never be returned by a successful malloc, and is used</div><div class="line">     * here to mark an arena_object that doesn't correspond to an</div><div class="line">     * allocated arena.</div><div class="line">     */</div><div class="line">     ...</div><div class="line">     &#125;</div></pre></td></tr></table></figure>
<p>当arena的area_object没和poll集合建立联系, arena处于未使用状态(单链表头<code>unused_arena_objects</code>), 一旦建立联系, arena转换为可用状态(双向链表头<code>usable_arenas</code>), 每个状态有一个arena链表</p>
<blockquote>
<p>arena是小块内存池的最上层结构, 所有arena的集合是小块内存池</p>
</blockquote>
<p>(小块内存和大块内存分界点是512字节), 小于512会在内存池中申请, 申请内存大于512时, PyObject_Malloc蜕变为molloc行为. python启动后, usedpools这个小块空间内存池并不存在任何可用的内存(不存在可用的pool), python采用延迟分配策略, 当确实开始申请小块内存是, python才建立内存池.</p>
<p>##4.2. 循环引用的垃圾收集</p>
<blockquote>
<p>python中大多数对象的生命周期是通过对象的引用计数来管理的. 广义上, 引用计数是一种最直接, 最简单的垃圾收集计数. python引入了标记-清除和分代收集计数来填补循环引用的缺陷.</p>
</blockquote>
<p>垃圾收集机制一般分为两个阶段: 垃圾检测和垃圾回收</p>
<ul>
<li>三色标记模型<ol>
<li>寻找根对象的集合, root object是一些全局引用和函数栈中的引用, 这些引用所用的对象不可被删除, root object集合是垃圾检测的起点</li>
<li>从root object集合出发, 沿着root object集合中的每个引用, 如果能到达某对象A, 称A可达, 可达对象不能被删除, 这阶段是垃圾检测阶段</li>
<li>垃圾检测后, 所有对象分为可达和不可达, 可达对象被保留, 不可达对象所占用内存将被回收, 这短短是垃圾回收阶段.</li>
</ol>
</li>
</ul>
<p>##4.3. Python中的垃圾收集</p>
<p>循环引用总是发生在container之间(内部可持有对其他对象的引用的对象, 如list, dict, class), python垃圾收集只需要检测这些container, container要成为可收集对象, 在PyObject_Head前加入PyGC_Head, 并将可收集container对象连接到python内部维护的可收集对象链表中.</p>
<p><img src="http://picturebag.qiniudn.com/72.png" alt="收集对象"></p>
<ul>
<li>分代的垃圾收集</li>
</ul>
<p>将系统所有的内存块按其存活时间划分为不同集合, 每个集合成为一个<code>代</code>, 垃圾收集的频率随着<code>代</code>的增大而减小. python中的分代收集, 分为<code>三代</code>.</p>
<ul>
<li>标记-清除方法</li>
</ul>
<p>从root object触发前, 将内存链表分为root链表和unreachable链表, 完成可达和不可达的标记, 最后unreachable链表中对象就是垃圾收集对象.</p>
</div></article></div></main><footer><div class="paginator"><a href="/2015/02/03/现代操作系统读书笔记/" class="prev">PREV</a><a href="/2015/01/24/计算机网络自顶向下方法读书笔记/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'snow-memory';
var disqus_identifier = '2015/01/29/Python源码剖析读书笔记-三/';
var disqus_title = 'Python源码剖析读书笔记(三)';
var disqus_url = 'http://andrewliu.in/2015/01/29/Python源码剖析读书笔记-三/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//snow-memory.disqus.com/count.js" async></script><div class="copyright"><p>© 2014 - 2017 <a href="http://andrewliu.in">Andrew Liu</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-58158116-2",'auto');ga('send','pageview');</script></body></html>