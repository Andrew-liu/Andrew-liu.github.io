<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Supervisor使用教程 · Snow Memory | Andrew Liu</title><meta name="description" content="Supervisor使用教程 - Andrew Liu"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://andrewliu.in/atom.xml" title="Snow Memory | Andrew Liu"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/dinosaurliu" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/Andrew-liu" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Supervisor使用教程</h1><div class="post-info">Feb 19, 2016</div><div class="post-content"><p>本博客采用创作共用版权协议, 要求署名、非商业用途和保持一致. 转载本博客文章必须也遵循<a href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh" target="_blank" rel="external">署名-非商业用途-保持一致</a>的创作共用协议.</p>
<p><a href="http://supervisord.org/" target="_blank" rel="external">Supervisor: 一个进程控制系统</a>, 用来监控类UNIX系统中的进程, 能够方便的启动, 重启, 关闭进程(<code>已经尝试过Python和Scala项目</code>)</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>Supervisor使用Python开发, 必然是可以使用<code>pip</code>进行安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ (sudo) pip install supervisor</div></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>通过<code>echo_supervisord_conf</code>命令将配置重定向到配置文件中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ echo_supervisord_conf &gt; /etc/supervisord.conf</div></pre></td></tr></table></figure>
<p>自动生成的配置如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">[unix_http_server]</div><div class="line">file=/tmp/supervisor.sock   ; UNIX socket 文件，supervisorctl 会使用</div><div class="line">;chmod=0700                 ; socket 文件的 mode，默认是 0700</div><div class="line">;chown=nobody:nogroup       ; socket 文件的 owner，格式： uid:gid</div><div class="line"></div><div class="line">;[inet_http_server]         ; HTTP 服务器，提供 web 管理界面</div><div class="line">;port=127.0.0.1:9001        ; Web 管理后台运行的 IP 和端口，如果开放到公网，需要注意安全性</div><div class="line">;username=user              ; 登录管理后台的用户名</div><div class="line">;password=123               ; 登录管理后台的密码</div><div class="line"></div><div class="line">[supervisord]</div><div class="line">logfile=/tmp/supervisord.log ; 日志文件，默认是 $CWD/supervisord.log</div><div class="line">logfile_maxbytes=50MB        ; 日志文件大小，超出会 rotate，默认 50MB</div><div class="line">logfile_backups=10           ; 日志文件保留备份数量默认 10</div><div class="line">loglevel=info                ; 日志级别，默认 info，其它: debug,warn,trace</div><div class="line">pidfile=/tmp/supervisord.pid ; pid 文件</div><div class="line">nodaemon=false               ; 是否在前台启动，默认是 false，即以 daemon 的方式启动</div><div class="line">minfds=1024                  ; 可以打开的文件描述符的最小值，默认 1024</div><div class="line">minprocs=200                 ; 可以打开的进程数的最小值，默认 200</div><div class="line"></div><div class="line">; the below section must remain in the config file for RPC</div><div class="line">; (supervisorctl/web interface) to work, additional interfaces may be</div><div class="line">; added by defining them in separate rpcinterface: sections</div><div class="line">[rpcinterface:supervisor]</div><div class="line">supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface</div><div class="line"></div><div class="line">[supervisorctl]</div><div class="line">serverurl=unix:///tmp/supervisor.sock ; 通过 UNIX socket 连接 supervisord，路径与 unix_http_server 部分的 file 一致</div><div class="line">;serverurl=http://127.0.0.1:9001 ; 通过 HTTP 的方式连接 supervisord</div><div class="line"></div><div class="line">; 包含其他的配置文件</div><div class="line">[include]</div><div class="line">files = relative/directory/*.ini    ; 可以是 *.conf 或 *.ini</div></pre></td></tr></table></figure>
<ul>
<li>通过命令运行supervisord</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 或者其他任意路径下的配置文件</div><div class="line">$ supervisord -c /etc/supervisord.conf</div></pre></td></tr></table></figure>
<h2 id="启动进程"><a href="#启动进程" class="headerlink" title="启动进程"></a>启动进程</h2><p>我们需要对自己的服务进行一些配置. 服务管理一般将配置文件存放在<code>/data/etc/supervisor/conf.d</code>路径下.</p>
<ul>
<li><code>[program:x]</code>, 其中x为进程名, 必不可少的</li>
<li><code>command</code>, 项目要运行的命令, 必不可少的</li>
<li><code>process_name</code>, 进程名, 如果要启动多个进程, 则修改修改, 默认为<code>%(program_name)%</code></li>
<li><code>numprocs</code>, 启动多个项目实例</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"># 文件名为 some-project.conf</div><div class="line">[program:some-project]  # program后跟着进程名是必须的</div><div class="line">command = /data/apps/some-project/bin/python /data/apps/doraemon/some-project/main.py</div><div class="line">autostart = true</div><div class="line">autorestart = true  # 服务挂掉会自动重启</div><div class="line">loglevel = info  # 输出日志级别</div><div class="line">stdout_logfile = /data/log/supervisor/some-project-stdout.log</div><div class="line">stderr_logfile = /data/log/supervisor/some-project-stderr.log</div><div class="line">stdout_logfile_maxbytes = 500MB</div><div class="line">stdout_logfile_backups = 50</div><div class="line">stdout_capture_maxbytes = 1MB</div><div class="line">stdout_events_enabled = false</div></pre></td></tr></table></figure>
<p>配置的模板基本如上, 只需要根据自己的服务定制<code>command</code>就可以了.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># scala项目的配置</div><div class="line">[program:owl-collector-scala]</div><div class="line">command=java -jar /data/apps/owl-collector-scala/target/scala-2.11/owl-collector-scala-assembly-1.0.jar</div><div class="line">autostart=false</div><div class="line">autorestart=true  </div><div class="line">stdout_logfile=/data/log/supervisor/owl-collector-scala.stdout.log</div><div class="line">stderr_logfile=/data/log/supervisor/owl-collector-scala.stderr.log</div><div class="line">stdout_logfile_maxbytes=500MB</div><div class="line">stdout_logfile_backups=50</div><div class="line">stdout_capture_maxbytes=1MB</div><div class="line">stdout_events_enabled=false</div><div class="line">loglevel=info</div><div class="line">priority=1100</div></pre></td></tr></table></figure>
<p>配置完成后, 进行<code>supervisorctl</code>命令行管理shell, 输入<code>reload</code>会进行重新加载进程配置.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># 加载配置</div><div class="line">$ supervisorctl</div><div class="line">supervisor&gt; reload</div><div class="line">Really restart the remote supervisord process y/N? y</div><div class="line">Restarted supervisord</div><div class="line"># 查看当前进程状态</div><div class="line">supervisor&gt; status</div><div class="line">some-project          STOPPED   Feb 19 11:33 PM</div><div class="line"># 启动进程</div><div class="line">supervisor&gt; start some-project</div></pre></td></tr></table></figure>
<h2 id="supervisorctl"><a href="#supervisorctl" class="headerlink" title="supervisorctl"></a>supervisorctl</h2><p><code>supervisorctl</code>是一个命令行工具. 可以与不同的supervisord进程进行通信, 获取子进程信息, 管理子进程.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># shell中输入supervisorctl, 进入交互式的界面</div><div class="line">$ supervisorctl</div><div class="line">&gt; status  # 查看当前supervisor管理的进程状态和运行时间</div><div class="line">&gt; start some-project  # 启动some-project进程</div><div class="line">&gt; stop some-project  # 关闭some-project进程</div><div class="line">&gt; restart some-project  # 重启some-project进程</div><div class="line">&gt; reload  # 重新加载配置文件(当增加新的配置文件时执行)</div><div class="line"></div><div class="line">&gt; tail -f some-project stderr  # 实时查看some-project的错误日志</div></pre></td></tr></table></figure>
<blockquote>
<p>不怎么使用Web进行进程管理, 更详细的配置信息可以查看<code>官方文档</code></p>
</blockquote>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a href="http://supervisord.org/running.html" target="_blank" rel="external">supervisor官方文档</a></li>
<li><a href="http://serverfault.com/questions/96499/how-to-automatically-start-supervisord-on-linux-ubuntu" target="_blank" rel="external">How to automatically start supervisord on Linux (Ubuntu)</a></li>
<li><a href="http://linbo.github.io/2013/04/04/supervisor/" target="_blank" rel="external">进程的守护神 - Supervisor</a></li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/2016/03/05/Zhihu实习总结/" class="prev">PREV</a><a href="/2016/02/07/Scala模式匹配和Try/" class="next">NEXT</a></div><div class="copyright"><p>© 2014 - 2017 <a href="http://andrewliu.in">Andrew Liu</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-58158116-2",'auto');ga('send','pageview');</script></body></html>