<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Python闭包和装饰器 · Snow Memory | Andrew Liu</title><meta name="description" content="Python闭包和装饰器 - Andrew Liu"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://andrewliu.in/atom.xml" title="Snow Memory | Andrew Liu"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/dinosaurliu" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/Andrew-liu" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Python闭包和装饰器</h1><div class="post-info">Dec 31, 2014</div><div class="post-content"><blockquote>
<p>测试版本python2.7.8</p>
</blockquote>
<p>#1. 闭包</p>
<blockquote>
<p>闭包是词法闭包的简称, 是引用了自由变量的函数. 这个被引用的自由变量和这个函数一同存在, 即使已经离开了创造它的环境也不例外. 所以有另一种说法认为闭包是由函数和其他相关的引用环境组合而成的实体. 闭包在运行时可以有多个实例, 不同的引用环境和函数组合可以产生不同的实例(维基百科)</p>
</blockquote>
<p>由上面这句话可以得到很多信息, 我们来解析一下:</p>
<ul>
<li>闭包是一个函数</li>
<li>这个函数引用了自由变量</li>
<li>闭包有一个创建它的环境, 并能够脱离创建环境存在</li>
</ul>
<a id="more"></a>
<blockquote>
<p>在python中, 当你调用一个函数A, 函数A传入了一个<code>自由变量</code>给函数A内的函数B, 函数B被称为闭包, 这个被传入的自由变量可以是变量或者函数等.</p>
</blockquote>
<p>看一下例子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_now</span><span class="params">(fn)</span> :</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fn_wrap</span><span class="params">(*args, **kwargs)</span> :</span></div><div class="line">        <span class="keyword">print</span> <span class="string">"now time: %s, the fn name: %s"</span> % (datetime.now(), fn.__name__)</div><div class="line">        <span class="keyword">return</span> fn(*args, **kwargs) <span class="comment">#执行fn函数, 并返回函数结果</span></div><div class="line">    <span class="keyword">return</span> fn_wrap</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name = <span class="string">"andrew"</span>)</span> :</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"Hello World! %s"</span> % name</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    temp = print_now(hello) </div><div class="line">    temp() <span class="comment">#fn_wrap在生命周期结束依然可以被调用</span></div><div class="line">    temp(<span class="string">"liu"</span>)</div></pre></td></tr></table></figure>
<p>打印结果</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">now time: <span class="number">2014</span><span class="number">-12</span><span class="number">-30</span> <span class="number">21</span>:<span class="number">53</span>:<span class="number">39.518521</span>, the fn name: hello</div><div class="line">Hello World! andrew</div><div class="line">now time: <span class="number">2014</span><span class="number">-12</span><span class="number">-30</span> <span class="number">21</span>:<span class="number">53</span>:<span class="number">39.518723</span>, the fn name: hello</div><div class="line">Hello World! liu</div></pre></td></tr></table></figure>
<p>这里<code>print_now</code>就相当于函数A, 函数A常被称为<code>工厂函数</code>, fn_wrap被称为<code>闭包</code>(函数B), fn被称为自由变量, <code>temp =print_now(hello)</code>这一句调用结束后,函数A返回一个闭包 <code>print_now</code>生命周期结束(<code>闭包(函数B)脱离创建环境继续存在</code>), 我们可以继续调用<code>temp()</code>, 来执行其中而的任务</p>
<p>我们再来看一个更简单的例子:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_msg</span><span class="params">(msg)</span> :</span></div><div class="line">    <span class="string">"""包裹层"""</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">printer</span><span class="params">()</span> :</span></div><div class="line">        <span class="string">"""闭包"""</span></div><div class="line">        <span class="keyword">print</span> msg</div><div class="line">    <span class="keyword">return</span> printer</div></pre></td></tr></table></figure>
<p>运行结果<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    temp = print_msg(<span class="string">"hello world"</span>)</div><div class="line">    temp()</div></pre></td></tr></table></figure></p>
<p><code>print_msg(&quot;hello world&quot;)</code>调用结束后, 传入的参数被保存在闭包中(<code>不过是否超出声明周期</code>), 如何验证这个说法呢</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#测试第一个例子, 显示是一个function(hello函数)</span></div><div class="line"><span class="keyword">print</span> temp.__closure__</div><div class="line">(&lt;cell at <span class="number">0x10a449910</span>: function object at <span class="number">0x10a434ed8</span>&gt;,)</div><div class="line"></div><div class="line"><span class="comment">#测试第二个例子, 显示一个str(python2.7.8中的字符串类型, "hello world")</span></div><div class="line"><span class="keyword">print</span> temp.__closure__</div><div class="line">(&lt;cell at <span class="number">0x1075b2948</span>: str object at <span class="number">0x1075bc060</span>&gt;,)</div></pre></td></tr></table></figure>
<p>闭包装它所引用的自由变量添加到了<code>__closure</code>中</p>
<p>在python中创建一个闭包的过程:</p>
<ol>
<li>有一个外部函数A(工厂函数)</li>
<li>外部函数A包裹一个内部函数B(闭包)</li>
<li>内部函数B使用外部函数传入的自由参数(参数)</li>
<li>外部函数A返回内部函数B</li>
</ol>
<blockquote>
<p>简而言之, 一个工厂函数创建并返回一个闭包, 并能够延长传入参数的生命周期(这里原理和<code>引用计数</code>有关, 不做深究)</p>
</blockquote>
<p>#2. 装饰器</p>
<blockquote>
<p>装饰器在python中<code>@</code>表示, 装饰器接受一个函数作为参数(或者更多参数), 返回一个函数</p>
</blockquote>
<p>我们直接修改第一个例子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_now</span><span class="params">(fn)</span> :</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fn_wrap</span><span class="params">(*args, **kwargs)</span> :</span></div><div class="line">        <span class="keyword">print</span> <span class="string">"now time: %s, the fn name: %s"</span> % (datetime.now(), fn.__name__)</div><div class="line">        <span class="keyword">return</span> fn(*args, **kwargs)</div><div class="line">    <span class="keyword">return</span> fn_wrap</div><div class="line"></div><div class="line"><span class="meta">@print_now</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name = <span class="string">"andrew"</span>)</span> :</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"Hello World! %s"</span> % name</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    hello()</div></pre></td></tr></table></figure>
<p>先看一下输出结果<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">now time: <span class="number">2014</span><span class="number">-12</span><span class="number">-30</span> <span class="number">22</span>:<span class="number">20</span>:<span class="number">34.724911</span>, the fn name: hello</div><div class="line">Hello World! andrew</div></pre></td></tr></table></figure></p>
<p>这中间发生了什么呢, </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@print_now</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name = <span class="string">"andrew"</span>)</span> :</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"Hello World! %s"</span> % name</div><div class="line"><span class="number">1.</span> 当@print_now接一行接着一个函数, 此处相当于将hello函数作为参数传给print_now函数</div><div class="line"><span class="number">2.</span> 这三行代码相当于执行了hello = print_now(hello), 即将print_now返回的闭包再次赋值给hello, 相当于此时的hello已经指向了闭包, 还不在是原来的函数</div><div class="line"><span class="number">3.</span> 我们hello(), 就是调用闭包</div></pre></td></tr></table></figure>
<p>再来看一个相对简单的例子:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_msg</span><span class="params">(fn)</span> :</span></div><div class="line">    <span class="string">"""包裹层"""</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">printer</span><span class="params">()</span> :</span></div><div class="line">        <span class="string">"""闭包"""</span></div><div class="line">        <span class="keyword">print</span> <span class="string">"被传入的函数名称: %s"</span> % fn.__name__</div><div class="line">        <span class="keyword">return</span> fn()</div><div class="line">    <span class="keyword">return</span> printer</div><div class="line"></div><div class="line"><span class="meta">@print_msg</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name = <span class="string">"andrew"</span>)</span> :</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"Hello World! %s"</span> % name</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    hello()</div><div class="line">    </div><div class="line"><span class="comment">#相当于</span></div><div class="line">hello = print_msg(hello)</div><div class="line">hello()</div></pre></td></tr></table></figure>
<p>你是否能够分析出最终的输出结果呢?</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">被传入的函数名称: hello</div><div class="line">Hello World! andrew</div></pre></td></tr></table></figure>
<p>#3. 何时使用闭包和装饰器</p>
<ul>
<li>定义私有类属性</li>
</ul>
<p>将<code>property</code>与装饰器结合实现属性私有化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#python内建函数</span></div><div class="line">property(fget=<span class="keyword">None</span>, fset=<span class="keyword">None</span>, fdel=<span class="keyword">None</span>, doc=<span class="keyword">None</span>)</div></pre></td></tr></table></figure>
<p><code>fget</code>是获取属性的值的函数,<code>fset</code>是设置属性值的函数,<code>fdel</code>是删除属性的函数,<code>doc</code>是一个字符串(like a comment).从实现来看，这些参数都是可选的</p>
<p>property有三个方法<code>getter()</code>, <code>setter()</code>和d<code>elete()</code> 来指定fget, fset和fdel。 这表示以下这行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">class Student(object):</div><div class="line"></div><div class="line">    @property  #相当于property.getter(score) 或者property(score)</div><div class="line">    def score(self):</div><div class="line">        return self._score</div><div class="line"></div><div class="line">    @score.setter #相当于score = property.setter(score)</div><div class="line">    def score(self, value):</div><div class="line">        if not isinstance(value, int):</div><div class="line">            raise ValueError(&apos;score must be an integer!&apos;)</div><div class="line">        if value &lt; 0 or value &gt; 100:</div><div class="line">            raise ValueError(&apos;score must between 0 ~ 100!&apos;)</div><div class="line">        self._score = value</div></pre></td></tr></table></figure>
<ul>
<li>对函数作简单的封装, 而不需要写一个类</li>
</ul>
<p>如果只需要对函数作封装可以使用闭包, 而不需要专门创建一个类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">def translator(frm = &apos;&apos;, to = &apos;&apos;, delete = &apos;&apos;, keep = None) :</div><div class="line">    if len(to) == 1 :</div><div class="line">        to = to * len(frm)</div><div class="line">    trans = string.maketrans(frm, to)</div><div class="line">    if keep is not None :</div><div class="line">        allchars = string.maketrans(&apos;&apos;, &apos;&apos;)</div><div class="line">        delete = allchars.translate(allchars, keep.translate(allchars, delete))</div><div class="line">    def translate(s) :</div><div class="line">        return s.translate(trans, delete)</div><div class="line">    return translate</div><div class="line"></div><div class="line"></div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line">    digits_only = translator(keep = string.digits)</div><div class="line">    print digits_only(&apos;Andrew Liu : 152-XXXX-XXXX&apos;)</div><div class="line">    </div><div class="line">#输出结果</div><div class="line">152</div></pre></td></tr></table></figure>
<ul>
<li>惰性求值</li>
<li>提前赋值</li>
</ul>
<p>#4. 更多阅读</p>
<p><a href="http://www.cnblogs.com/inevermore/p/4189225.html" target="_blank" rel="external">Python闭包的高级应用-装饰器的实现</a><br><a href="http://www.the5fire.com/closure-in-python.html" target="_blank" rel="external">Python中的闭包</a><br><a href="http://www.liaoxuefeng.com/wiki/001374738125095c955c1e6d8bb493182103fac9270762a000/001386819879946007bbf6ad052463ab18034f0254bf355000" target="_blank" rel="external">装饰器</a><br><a href="http://stackoverflow.com/questions/4020419/closures-in-python" target="_blank" rel="external">Closures in Python</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/2015/01/02/Python源码剖析读书笔记-一/" class="prev">PREV</a><a href="/2014/12/28/Django搭建简易博客教程-八-动态URL/" class="next">NEXT</a></div><div class="copyright"><p>© 2014 - 2017 <a href="http://andrewliu.in">Andrew Liu</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-58158116-2",'auto');ga('send','pageview');</script></body></html>